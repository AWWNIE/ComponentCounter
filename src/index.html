<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RS3 Drop Notifier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />

  <!-- Bootstrap JS Bundle (required for modals, dropdowns, etc.) -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>

  <!-- RuneApps/NIS CSS -->
  <link
    rel="stylesheet"
    type="text/css"
    href="https://runeapps.org/nis/nis.css"
  />
  <link
    rel="stylesheet"
    type="text/css"
    href="https://runeapps.org/runeappslib.css"
  />

  <!-- Custom RS3‐style overrides -->
  <style>
    /* Body background and font */
    body.nis {
      background-color: #1e1e1e;
      font-family: 'RuneScape UF', sans-serif;
    }

    /* Discord form card styling */
    #discordFormContainer .card {
      background-color: #292929;
      border: 2px solid #A67D3D;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
    }
    #discordFormContainer .card-body {
      padding: 1.5rem;
    }
    #discordFormContainer .card-title {
      color: #E2BE62;
      font-size: 1.25rem;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    /* Labels and inputs */
    #discordFormContainer .form-label {
      color: #FFFFFF;
      font-weight: bold;
      text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.4);
    }
    #discordFormContainer .form-control {
      background-color: #1f1f1f;
      border: 1px solid #A67D3D;
      color: #FFFFFF;
      border-radius: 4px;
    }
    #discordFormContainer .form-control::placeholder {
      color: #AAAAAA;
    }
    #discordFormContainer .form-control:focus {
      border-color: #E2BE62;
      box-shadow: 0 0 5px rgba(166, 125, 61, 0.8);
      background-color: #1f1f1f;
    }

    /* Buttons */
    #discordFormContainer .btn {
      background-color: #3C3C3C;
      border: 1px solid #A67D3D;
      color: #E2BE62;
      font-weight: bold;
      text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.4);
      border-radius: 4px;
    }
    #discordFormContainer .btn:hover {
      background-color: #555555;
      border-color: #E2BE62;
    }
    #discordFormContainer .btn-outline-secondary {
      background-color: transparent;
      border: 1px solid #A67D3D;
      color: #E2BE62;
    }
    #discordFormContainer .btn-outline-secondary:hover {
      background-color: #3C3C3C;
      border-color: #E2BE62;
      color: #FFFFFF;
    }

    /* Status icons (success / error) */
    #saveStatusContainer .text-success {
      color: #4EC83D !important;
    }
    #saveStatusContainer .text-danger {
      color: #C83D3D !important;
    }
    #saveStatusContainer .text-white {
      color: #FFFFFF !important;
    }

    /* Center the Skip button text */
    #skipDiscordBtn {
      margin-top: 0.5rem;
    }
  </style>
</head>

<body class="nis">
  <!-- ============================================= -->
  <!-- Step 1: Discord‐input form (shown first)      -->
  <!-- ============================================= -->
  <div id="discordFormContainer" class="container my-5">
    <div class="row">
      <div class="col-12 col-md-6 offset-md-3">
        <div class="card">
          <div class="card-body">

            <!-- Container for form fields -->
            <div id="discordFormFields">
              <h5 class="card-title text-center mb-4">Discord Settings</h5>

              <!-- Discord ID input -->
              <div class="mb-3">
                <label for="discordIdInput" class="form-label">Discord ID</label>
                <input
                  type="text"
                  id="discordIdInput"
                  class="form-control"
                  placeholder="Enter your Discord ID"
                />
              </div>

              <!-- Discord Webhook input -->
              <div class="mb-4">
                <label for="discordWebhookInput" class="form-label">
                  Discord Webhook URL
                </label>
                <input
                  type="text"
                  id="discordWebhookInput"
                  class="form-control"
                  placeholder="Enter your Webhook URL"
                />
              </div>

              <!-- Save button -->
              <button id="saveDiscordBtn" class="btn btn-primary w-100 mb-2">
                Save
              </button>

              <!-- Load Saved Info button -->
              <button id="loadSavedBtn" class="btn btn-secondary w-100 mb-2">
                Load Saved Info
              </button>

              <!-- Skip Discord Integration button -->
              <button id="skipDiscordBtn" class="btn btn-outline-secondary w-100">
                Skip
              </button>
            </div>

            <!-- Container for spinner / success / error icon -->
            <div id="saveStatusContainer" class="text-center my-4" style="display: none;">
              <!-- Content inserted dynamically -->
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================= -->
  <!-- Step 2: Original content (hidden initially)   -->
  <!-- ============================================= -->
  <div id="mainContent" style="display: none;">
    <ul class="itemList list-group">
      <li class="list-group-item header" data-show="history" title="Loading">
        Loading...
      </li>
      <li class="list-group-item total">
        Total Seren Spirits collected:
        <span id="total" style="font-weight:bold"></span>
      </li>
      <li
        class="list-group-item item"
        style="word-wrap:break-word;white-space: normal"
      >
        If this message is showing for an extended period of time, then the
        chatbox reader for Alt1 isn't working due to an update. Please be
        patient, and the issue will be fixed as soon as it can!
      </li>
    </ul>

    <div class="container">
      <div class="row fixed-bottom">
        <div class="col">
          <div class="row">
            <div class="col">
              <button
                class="nisbutton"
                data-bs-toggle="modal"
                data-bs-target="#settings"
                type="button"
              >
                Settings
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal nis"
      tabindex="-1"
      role="dialog"
      id="settings"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Settings</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div
                class="col"
                title="Allows the user to select the chat box the app should
                target."
              >
                <h6>Select Chat</h6>
              </div>
              <div class="col">
                <select class="chat">
                  <option value="">Select Chat</option>
                </select>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col" title="Exports the current data as a CSV file.">
                <button class="nisbutton export">CSV Export</button>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col">
                <button
                  class="nisbutton"
                  data-type="reset"
                  data-bs-toggle="collapse"
                  href="#resetApp"
                >
                  Factory Reset
                </button>
              </div>
            </div>
            <div class="row collapse danger" id="resetApp">
              <div class="col">
                <div class="row">
                  <div class="col text-center">
                    This will remove all saved data and set all settings to
                    default. This is irreversible!
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col">
                    <button
                      class="nisbutton clear"
                      data-type="reset"
                      data-bs-toggle="collapse"
                      href="#resetApp"
                    >
                      Yes
                    </button>
                  </div>
                  <div class="col">
                    <button
                      class="nisbutton"
                      data-bs-toggle="collapse"
                      href="#resetApp"
                    >
                      No
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>  
    </div>
  </div> <!-- end #mainContent -->

  <!-- ============================================ -->
  <!-- Load your compiled TypeScript (main.js)     -->
  <!-- ============================================ -->
  <script src="./main.js"></script>

  <!-- ============================================ -->
  <!-- Inline script: loading → success/error → show content -->
  <!-- ============================================ -->
  <script>
    const APP_INSTALL_URL = 'https://awwnie.github.io/ComponentCounter/appconfig.json';

    const discordFormContainer = document.getElementById("discordFormContainer");
    const discordFormFields    = document.getElementById("discordFormFields");
    const saveStatusContainer  = document.getElementById("saveStatusContainer");
    const mainContent          = document.getElementById("mainContent");
    const discordIdInput       = document.getElementById("discordIdInput");
    const discordWebhookInput  = document.getElementById("discordWebhookInput");
    const saveBtn              = document.getElementById("saveDiscordBtn");
    const loadSavedBtn         = document.getElementById("loadSavedBtn");
    const skipBtn              = document.getElementById("skipDiscordBtn");

    // Helper: bind the dynamic “Install” button inside the error container
    function bindInstallButton() {
      const installBtn = document.getElementById("installBtn");
      if (!installBtn) return;

      installBtn.addEventListener("click", () => {
        // If we’re inside Alt1’s built-in browser, call the API:
        if (typeof alt1 !== "undefined" && typeof alt1.installApp === "function") {
          alt1.installApp(APP_INSTALL_URL).catch((err) => {
            console.error("alt1.installApp failed:", err);
            saveStatusContainer.textContent = "Failed to install via Alt1 API.";
          });
          return;
        }
        // Otherwise, fall back to the protocol link
        window.location.href = `alt1://addapp/${APP_INSTALL_URL}`;
      });
    }

    // Show an error screen if Alt1 is not installed or permissions missing.
    function showAlt1Error(type) {
      discordFormFields.style.display = "none";

      let messageText;
      if (type === "notInstalled") {
        messageText = "App is not installed through Alt1.";
      } else {
        messageText = "Required permissions not granted. Ensure gamestate, overlay, and pixel permissions are all enabled.";
      }

      // Replace the old anchor with a button we can bind
      saveStatusContainer.innerHTML = `
        <div class="fs-1 text-danger">❌</div>
        <div class="mt-2 text-white">${messageText}</div>
        <div class="mt-3">
          <button id="installBtn" class="btn btn-primary">Install</button>
        </div>
      `;
      saveStatusContainer.style.display = "block";

      // Bind our “Install” button listener now that it’s in the DOM
      bindInstallButton();
    }

    // Show a temporary success screen with green checks for Alt1 and permissions.
    function showAlt1Success(callback) {
      discordFormFields.style.display = "none";
      saveStatusContainer.innerHTML = `
        <div class="fs-1 text-success">✅</div>
        <div class="mt-2 text-white">Alt1 is installed and all permissions granted:</div>
        <div class="text-start mt-2">
          <div class="text-white">✅ Alt1 installed</div>
          <div class="text-white">✅ Gamestate</div>
          <div class="text-white">✅ Overlay</div>
          <div class="text-white">✅ Pixel</div>
        </div>
      `;
      saveStatusContainer.style.display = "block";

      setTimeout(() => {
        saveStatusContainer.style.display = "none";
        callback();
      }, 2000);
    }

    // Wrapper: check Alt1 presence & required permissions, then proceed or error
    function checkAlt1AndProceed(callback) {
      if (!window.alt1 || !alt1.permissionInstalled) {
        showAlt1Error("notInstalled");
        return;
      }
      if (!alt1.permissionGameState || !alt1.permissionOverlay || !alt1.permissionPixel) {
        showAlt1Error("noPermission");
        return;
      }
      showAlt1Success(callback);
    }

    // On page load, decide which button to show
    window.addEventListener("DOMContentLoaded", () => {
      mainContent.style.display = "none";

      const storedId = localStorage.getItem("discordID");
      const storedWebhook = localStorage.getItem("discordWebhook");

      // Always display Save button
      saveBtn.style.display = "block";

      if (storedId && storedWebhook) {
        loadSavedBtn.style.display = "block";
      } else {
        loadSavedBtn.style.display = "none";
      }
    });

    // Load Saved Info: check Alt1, then show spinner, validate, apply or show error
    loadSavedBtn.addEventListener("click", () => {
      checkAlt1AndProceed(() => {
        const storedId = localStorage.getItem("discordID") || "";
        const storedWebhook = localStorage.getItem("discordWebhook") || "";

        // Immediately hide form fields and show spinner
        discordFormFields.style.display = "none";
        saveStatusContainer.innerHTML = `
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading…</span>
          </div>
        `;
        saveStatusContainer.style.display = "block";

        setTimeout(() => {
          // Validate retrieved values
          const idValid      = /^\d{18}$/.test(storedId);
          const webhookValid = storedWebhook.startsWith("https://discord.com/api/webhooks/");

          if (!idValid || !webhookValid) {
            let errorMessage = "";
            if (!idValid && !webhookValid) {
              errorMessage = "Invalid Discord ID and Discord Webhook.";
            } else if (!idValid) {
              errorMessage = "A valid Discord ID was not entered.";
            } else {
              errorMessage = "A valid Discord Webhook was not entered.";
            }

            saveStatusContainer.innerHTML = `
              <div class="fs-1 text-danger">❌</div>
              <div class="mt-2 text-white">${errorMessage}</div>
            `;

            // After 2 seconds, hide status and show form again
            setTimeout(() => {
              saveStatusContainer.style.display = "none";
              discordFormFields.style.display = "block";
            }, 2000);
          } else {
            // Valid: call updateSaveData and show success
            updateSaveData({ discordID: storedId });
            updateSaveData({ discordWebhook: storedWebhook });

            saveStatusContainer.innerHTML = `
              <div class="fs-1 text-success">✅</div>
              <div class="mt-2 text-white">Loaded successfully</div>
            `;

            // After 2 seconds, hide form container and show main content
            setTimeout(() => {
              discordFormContainer.style.display = "none";
              mainContent.style.display = "block";
            }, 2000);
          }
        }, 2000);
      });
    });

    // Save New Info: check Alt1, then validate inputs, save, and proceed
    saveBtn.addEventListener("click", () => {
      checkAlt1AndProceed(() => {
        const idValue      = discordIdInput.value.trim();
        const webhookValue = discordWebhookInput.value.trim();

        // VALIDATE inputs before saving:
        const idValid = /^\d{18}$/.test(idValue);
        const webhookValid = webhookValue.startsWith("https://discord.com/api/webhooks/");

        if (!idValid || !webhookValid) {
          // Hide form fields, show red X + appropriate error text
          discordFormFields.style.display = "none";

          let errorMessage = "";
          if (!idValid && !webhookValid) {
            errorMessage = "Invalid Discord ID and Discord Webhook.";
          } else if (!idValid) {
            errorMessage = "A valid Discord ID was not entered.";
          } else {
            errorMessage = "A valid Discord Webhook was not entered.";
          }

          saveStatusContainer.innerHTML = `
            <div class="fs-1 text-danger">❌</div>
            <div class="mt-2 text-white">${errorMessage}</div>
          `;
          saveStatusContainer.style.display = "block";

          // After 2 seconds, hide the status and return to the form
          setTimeout(() => {
            saveStatusContainer.style.display = "none";
            discordFormFields.style.display = "block";
          }, 2000);

          return;
        }

        // Store valid inputs in localStorage
        localStorage.setItem("discordID", idValue);
        localStorage.setItem("discordWebhook", webhookValue);

        // After storing, ensure Load button is visible
        loadSavedBtn.style.display = "block";

        // Call existing save‐to‐localStorage functions:
        updateSaveData({ discordID: idValue });
        updateSaveData({ discordWebhook: webhookValue });

        // Hide the input fields
        discordFormFields.style.display = "none";

        // Show a Bootstrap spinner
        saveStatusContainer.innerHTML = `
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Saving…</span>
          </div>
        `;
        saveStatusContainer.style.display = "block";

        // After 2 seconds, replace spinner with success or error icon
        setTimeout(() => {
          const savedId = getSaveData("discordID");
          const savedWebhook = getSaveData("discordWebhook");
          const success = savedId && savedWebhook;

          if (success) {
            saveStatusContainer.innerHTML = `
              <div class="fs-1 text-success">✅</div>
              <div class="mt-2 text-white">Saved successfully</div>
            `;
          } else {
            saveStatusContainer.innerHTML = `
              <div class="fs-1 text-danger">❌</div>
              <div class="mt-2 text-white">Save failed</div>
            `;
          }

          // After another 2 seconds, hide the form and show main content
          setTimeout(() => {
            discordFormContainer.style.display = "none";
            mainContent.style.display = "block";
          }, 2000);
        }, 2000);
      });
    });

    // Skip Discord Integration: clear saved data, clear updateSaveData, hide the form, and show main content
    skipBtn.addEventListener("click", () => {
      // Clear any localStorage entries
      localStorage.removeItem("discordID");
      localStorage.removeItem("discordWebhook");

      // Clear persisted data via updateSaveData
      updateSaveData({ discordID: "" });
      updateSaveData({ discordWebhook: "" });

      // Hide discord form and show main content
      discordFormContainer.style.display = "none";
      mainContent.style.display = "block";
    });
  </script>
</body>
</html>
