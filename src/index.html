<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RS3 Drop Notifier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />

  <!-- Bootstrap JS Bundle (required for modals, dropdowns, etc.) -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>

  <!-- Your other CSS -->
  <link
    rel="stylesheet"
    type="text/css"
    href="https://runeapps.org/nis/nis.css"
  />
  <link
    rel="stylesheet"
    type="text/css"
    href="https://runeapps.org/runeappslib.css"
  />
</head>

<body class="nis">
  <!-- ============================================= -->
  <!-- Step 1: Discord‐input form (shown first)      -->
  <!-- ============================================= -->
  <div id="discordFormContainer" class="container my-5">
    <div class="row">
      <div class="col-12 col-md-6 offset-md-3">
        <div class="card shadow-sm">
          <div class="card-body">

            <!-- Container for form fields -->
            <div id="discordFormFields">
              <h5 class="card-title text-center mb-4">Discord Settings</h5>

              <!-- Discord ID input -->
              <div class="mb-3">
                <label for="discordIdInput" class="form-label">Discord ID</label>
                <input
                  type="text"
                  id="discordIdInput"
                  class="form-control"
                  placeholder="Enter your Discord ID"
                />
              </div>

              <!-- Discord Webhook input -->
              <div class="mb-4">
                <label for="discordWebhookInput" class="form-label">
                  Discord Webhook URL
                </label>
                <input
                  type="text"
                  id="discordWebhookInput"
                  class="form-control"
                  placeholder="Enter your Webhook URL"
                />
              </div>

              <!-- Save button (always enabled) -->
              <button id="saveDiscordBtn" class="btn btn-primary w-100">
                Save
              </button>
            </div>

            <!-- Container for spinner / success / error icon -->
            <div id="saveStatusContainer" class="text-center my-4" style="display: none;">
              <!-- Content inserted dynamically -->
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================= -->
  <!-- Step 2: Original content (hidden initially)   -->
  <!-- ============================================= -->
  <div id="mainContent" style="display: none;">
    <ul class="itemList list-group">
      <li class="list-group-item header" data-show="history" title="Loading">
        Loading...
      </li>
      <li class="list-group-item total">
        Total Seren Spirits collected:
        <span id="total" style="font-weight:bold"></span>
      </li>
      <li
        class="list-group-item item"
        style="word-wrap:break-word;white-space: normal"
      >
        If this message is showing for an extended period of time, then the
        chatbox reader for Alt1 isn't working due to an update. Please be
        patient, and the issue will be fixed as soon as it can!
      </li>
    </ul>

    <div class="container">
      <div class="row fixed-bottom">
        <div class="col">
          <div class="row">
            <div class="col">
              <button
                class="nisbutton"
                data-bs-toggle="modal"
                data-bs-target="#settings"
                type="button"
              >
                Settings
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal nis"
      tabindex="-1"
      role="dialog"
      id="settings"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Settings</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div
                class="col"
                title="Allows the user to select the chat box the app should
                target."
              >
                <h6>Select Chat</h6>
              </div>
              <div class="col">
                <select class="chat">
                  <option value="">Select Chat</option>
                </select>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col" title="Exports the current data as a CSV file.">
                <button class="nisbutton export">CSV Export</button>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col">
                <button
                  class="nisbutton"
                  data-type="reset"
                  data-bs-toggle="collapse"
                  href="#resetApp"
                >
                  Factory Reset
                </button>
              </div>
            </div>
            <div class="row collapse danger" id="resetApp">
              <div class="col">
                <div class="row">
                  <div class="col text-center">
                    This will remove all saved data and set all settings to
                    default. This is irreversible!
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col">
                    <button
                      class="nisbutton clear"
                      data-type="reset"
                      data-bs-toggle="collapse"
                      href="#resetApp"
                    >
                      Yes
                    </button>
                  </div>
                  <div class="col">
                    <button
                      class="nisbutton"
                      data-bs-toggle="collapse"
                      href="#resetApp"
                    >
                      No
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>  
    </div>
  </div> <!-- end #mainContent -->

  <!-- ============================================ -->
  <!-- Load your compiled TypeScript (main.js)     -->
  <!-- ============================================ -->
  <script src="./main.js"></script>

  <!-- ============================================ -->
  <!-- Inline script: loading → success/error → show content -->
  <!-- ============================================ -->
  <script>
    const discordFormContainer = document.getElementById("discordFormContainer");
    const discordFormFields    = document.getElementById("discordFormFields");
    const saveStatusContainer  = document.getElementById("saveStatusContainer");
    const mainContent          = document.getElementById("mainContent");
    const discordIdInput       = document.getElementById("discordIdInput");
    const discordWebhookInput  = document.getElementById("discordWebhookInput");
    const saveBtn              = document.getElementById("saveDiscordBtn");

    saveBtn.addEventListener("click", () => {
      const idValue      = discordIdInput.value.trim();
      const webhookValue = discordWebhookInput.value.trim();

      // 1) VALIDATE inputs before saving:
      const idValid = /^\d{18}$/.test(idValue);
      const webhookValid = webhookValue.startsWith("https://discord.com/api/webhooks/");

      if (!idValid || !webhookValid) {
        // Hide form fields, show red X + appropriate error text
        discordFormFields.style.display = "none";

        let errorMessage = "";
        if (!idValid && !webhookValid) {
          errorMessage = "Invalid Discord ID and Discord Webhook.";
        } else if (!idValid) {
          errorMessage = "A valid Discord ID was not entered.";
        } else {
          errorMessage = "A valid Discord Webhook was not entered.";
        }

        saveStatusContainer.innerHTML = `
          <div class="fs-1 text-danger">❌</div>
          <div class="mt-2">${errorMessage}</div>
        `;
        saveStatusContainer.style.display = "block";

        // After 2 seconds, hide the status and return to the form
        setTimeout(() => {
          saveStatusContainer.style.display = "none";
          discordFormFields.style.display = "block";
        }, 2000);

        // Do not proceed to save or show main content
        return;
      }

      // 2) If we reach here, BOTH inputs are valid, so proceed with existing logic:

      // (a) Call your existing save‐to‐localStorage functions:
      updateSaveData({ discordID: idValue });
      updateSaveData({ discordWebhook: webhookValue });

      // (b) Hide the input fields and Save button
      discordFormFields.style.display = "none";

      // (c) Show a Bootstrap spinner in saveStatusContainer
      saveStatusContainer.innerHTML = `
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Saving…</span>
        </div>
      `;
      saveStatusContainer.style.display = "block";

      // (d) After 2 seconds, replace spinner with success or error icon
      setTimeout(() => {
        // Check if both values were actually saved:
        const savedId = getSaveData("discordID");
        const savedWebhook = getSaveData("discordWebhook");
        const success = savedId && savedWebhook;

        if (success) {
          saveStatusContainer.innerHTML = `
            <div class="fs-1 text-success">✅</div>
            <div class="mt-2">Saved successfully</div>
          `;
        } else {
          saveStatusContainer.innerHTML = `
            <div class="fs-1 text-danger">❌</div>
            <div class="mt-2">Save failed</div>
          `;
        }

        // (e) After another 2 seconds, hide the entire form and show main content
        setTimeout(() => {
          discordFormContainer.style.display = "none";
          mainContent.style.display = "block";
        }, 2000);
      }, 2000);
    });

    // Ensure original content is hidden on page load:
    window.addEventListener("DOMContentLoaded", () => {
      mainContent.style.display = "none";
    });
  </script>
</body>
</html>
