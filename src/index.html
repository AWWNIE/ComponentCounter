<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rasial Drop Notifier (Manual Chat Region)</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />

  <!-- Bootstrap Bundle (JS + Popper) -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>

  <!-- RuneApps CSS -->
  <link rel="stylesheet" type="text/css" href="https://runeapps.org/nis/nis.css" />
  <link rel="stylesheet" type="text/css" href="https://runeapps.org/runeappslib.css" />

  <!-- DO NOT load alt1.min.js from CDN—Alt1 injects `alt1` automatically -->
  <!-- <script src="https://cdn.alt1.s3.amazonaws.com/alt1/alt1.min.js"></script> -->

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #1e1e1e;
      color: #f0f0f0;
      margin: 0;
      padding: 16px;
    }
    h2 {
      margin-bottom: 4px;
    }
    p {
      margin-top: 0;
      font-size: 0.9rem;
      color: #ccc;
    }
    #status {
      margin-top: 12px;
      font-size: 0.9rem;
      color: #fa0;
    }
    label {
      display: block;
      margin-top: 12px;
      font-size: 0.9rem;
    }
    input, button {
      margin-top: 4px;
      padding: 6px;
      font-size: 0.9rem;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #555;
      background: #2e2e2e;
      color: #f0f0f0;
      outline: none;
    }
    button {
      cursor: pointer;
      background: #007acc;
      border: none;
      color: white;
      transition: background 0.2s;
    }
    button:hover {
      background: #005a99;
    }
    .section {
      margin-bottom: 16px;
      padding: 12px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #2a2a2a;
    }
  </style>
</head>
<body>
  <h2>Rasial Drop Notifier</h2>
  <p>Enter your Discord details and chat‐box region manually, then click “Start Monitoring.”</p>

  <div class="section">
    <label for="webhookUrl">Discord Webhook URL</label>
    <input
      type="text"
      id="webhookUrl"
      placeholder="https://discord.com/api/webhooks/…" />

    <label for="userId">Your Discord User ID</label>
    <input
      type="text"
      id="userId"
      placeholder="123456789012345678" />
  </div>

  <div class="section">
    <label>Chat‐Box Region (in game‐client coordinates)</label>
    <small style="color:#ccc;">Provide X, Y relative to top‐left of RuneScape window, plus width &amp; height.</small>

    <label for="offsetX">Chat Offset X</label>
    <input type="number" id="offsetX" placeholder="e.g. 10" />

    <label for="offsetY">Chat Offset Y</label>
    <input type="number" id="offsetY" placeholder="e.g. 800" />

    <label for="chatWidth">Chat Width</label>
    <input type="number" id="chatWidth" placeholder="e.g. 496" />

    <label for="chatHeight">Chat Height</label>
    <input type="number" id="chatHeight" placeholder="e.g. 120" />
  </div>

  <button id="startBtn">Start Monitoring</button>
  <div id="status">Idle</div>

  <script>
    // ============================
    // GLOBAL STATE & CONFIGURATION
    // ============================
    let DISCORD_WEBHOOK = "";
    let DISCORD_USER_ID = "";
    let lastKillCount = 0;
    let monitoring = false;
    let scanHandle = null;

    // How often (ms) to re-scan the chat
    const SCAN_INTERVAL = 10 * 1000; // 10 seconds

    // Cached chat region object { x, y, width, height }
    let chatRegion = null;

    // ===========================
    // UTILITY / HELPER FUNCTIONS
    // ===========================
    function updateStatus(msg) {
      document.getElementById("status").innerText = msg;
    }

    /**
     * scanChatOnce( ) → void
     *
     * Captures the predefined chatRegion via alt1.capture, OCRs it, and
     * looks for:
     *  - “You have killed Rasial … (#) times”
     *  - “Your <ItemName> (<value>) has appeared on the ground”
     * If found and kill‐count > lastKillCount, sends a Discord message and updates lastKillCount.
     */
    async function scanChatOnce() {
      if (typeof alt1 === "undefined") {
        updateStatus("Must run inside Alt1.");
        return;
      }
      if (!chatRegion) {
        updateStatus("Chat region not set. Stopping.");
        return;
      }

      const { x, y, width, height } = chatRegion;
      try {
        // Use alt1.capture(startX, startY, width, height)
        const img = await alt1.capture(x, y, width, height);
        const rawText = await alt1.ocrText(img);
        if (!rawText) {
          updateStatus("No text detected in chat.");
          return;
        }

        const lines = rawText.split("\n");
        let currentKC = lastKillCount;

        for (const line of lines) {
          // 1) Kill count pattern: “You have killed Rasial … (#) times”
          const kcMatch = line.match(/You have killed Rasial.*?([\d,]+)\s+times/i);
          if (kcMatch) {
            currentKC = parseInt(kcMatch[1].replace(/,/g, ""), 10);
          }

          // 2) Rare drop pattern: “Your <Item> (<value>) has appeared on the ground”
          const dropMatch = line.match(/Your\s+(.+?)\s+\(([\d,]+)\)\s+has appeared/i);
          if (dropMatch && currentKC > lastKillCount) {
            const itemName = dropMatch[1].trim();
            const value = dropMatch[2].replace(/,/g, "");
            const timeStr = new Date().toLocaleString();
            await sendToDiscord(itemName, value, currentKC, timeStr);
            lastKillCount = currentKC;
          }
        }

        updateStatus(
          `Last KC: ${lastKillCount} | Next check at ${new Date().toLocaleTimeString()}`
        );
      } catch (err) {
        console.error("Error scanning chat:", err);
        updateStatus("Error scanning chat—see console.");
      }
    }

    /**
     * sendToDiscord( itemName, value, killCount, timeStr ) → void
     *
     * Wraps the stored Discord user ID in <@…> for mention,
     * composes a message, and POSTs it to the configured webhook.
     */
    async function sendToDiscord(itemName, value, killCount, timeStr) {
      if (!DISCORD_WEBHOOK) {
        console.warn("No webhook URL set; skipping Discord post.");
        return;
      }
      const mention = `<@${DISCORD_USER_ID}>`;
      const content =
        `${mention} Rare drop detected!\n` +
        `• Item: **${itemName}**\n` +
        `• Value: **${value} gp**\n` +
        `• Kill Count: **${killCount}**\n` +
        `• Time: **${timeStr}`;

      try {
        await fetch(DISCORD_WEBHOOK, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ content })
        });
        console.log("Discord payload sent:", content);
      } catch (err) {
        console.error("Failed to post to Discord:", err);
      }
    }

    /**
     * toggleMonitoring( ) → void
     *
     * On start:
     *  - Reads Discord webhook, user ID, and manual chat region inputs.
     *  - Validates them.
     *  - Caches chatRegion = { x, y, width, height }.
     *  - Kicks off scanChatOnce() immediately and every SCAN_INTERVAL.
     *
     * On stop:
     *  - Clears the interval, resets state.
     */
    function toggleMonitoring() {
      if (!monitoring) {
        // 1) Read and validate Discord inputs
        DISCORD_WEBHOOK = document.getElementById("webhookUrl").value.trim();
        DISCORD_USER_ID = document.getElementById("userId").value.trim();
        if (!DISCORD_WEBHOOK || !DISCORD_USER_ID) {
          alert("Please enter both a Discord Webhook URL and your Discord User ID.");
          return;
        }
        if (!/^\d+$/.test(DISCORD_USER_ID)) {
          alert("Discord User ID must be numeric (no <@…> brackets).");
          return;
        }

        // 2) Read and validate chat region inputs
        const offsetX = parseInt(document.getElementById("offsetX").value, 10);
        const offsetY = parseInt(document.getElementById("offsetY").value, 10);
        const chatW   = parseInt(document.getElementById("chatWidth").value, 10);
        const chatH   = parseInt(document.getElementById("chatHeight").value, 10);

        if (
          isNaN(offsetX) ||
          isNaN(offsetY) ||
          isNaN(chatW)   ||
          isNaN(chatH)   ||
          offsetX < 0    ||
          offsetY < 0    ||
          chatW  <= 0    ||
          chatH  <= 0
        ) {
          alert("Please enter valid positive numbers for chat region (X, Y, width, height).");
          return;
        }

        // 3) Cache the chatRegion
        if (typeof alt1 === "undefined") {
          alert("You must run this inside Alt1 for alt1.capture to work.");
          return;
        }
        // alt1.rsX/rsY = top-left of RuneScape window
        chatRegion = {
          x: alt1.rsX + offsetX,
          y: alt1.rsY + offsetY,
          width: chatW,
          height: chatH
        };

        monitoring = true;
        document.getElementById("startBtn").innerText = "Stop Monitoring";
        updateStatus("Initializing scan…");

        // Run first scan immediately, then set interval
        scanChatOnce();
        scanHandle = setInterval(scanChatOnce, SCAN_INTERVAL);
      } else {
        // Stop Monitoring
        monitoring = false;
        document.getElementById("startBtn").innerText = "Start Monitoring";
        clearInterval(scanHandle);
        updateStatus("Stopped.");
      }
    }

    // ================
    // EVENT LISTENERS
    // ================
    document.getElementById("startBtn").addEventListener("click", toggleMonitoring);

    window.addEventListener("load", () => {
      updateStatus("Idle. Enter Discord & chat‐region, then click Start.");
    });
  </script>
</body>
</html>
