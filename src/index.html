<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RS3 Item Price Notifier</title>
</head>
<body>
  <h1>RS3 Item Price Notifier</h1>

  <label for="itemName">Item Name (e.g. abyssal_whip):</label><br />
  <input type="text" id="itemName" placeholder="abyssal_whip" /><br /><br />

  <label for="webhookUrl">Discord Webhook URL:</label><br />
  <input
    type="text"
    id="webhookUrl"
    placeholder="https://discord.com/api/webhooks/…"
    style="width: 350px;"
  /><br /><br />

  <label for="userId">Discord User ID:</label><br />
  <input type="text" id="userId" placeholder="123456789012345678" /><br /><br />

  <button id="sendBtn">Send Price to Discord</button>

  <script>
    document.getElementById("sendBtn").addEventListener("click", async () => {
      const itemNameInput = document
        .getElementById("itemName")
        .value.trim();
      const webhookUrl = document
        .getElementById("webhookUrl")
        .value.trim();
      const userId = document.getElementById("userId").value.trim();

      if (!itemNameInput || !webhookUrl || !userId) {
        alert("Please fill in all fields.");
        return;
      }

      try {
        // 1. Fetch latest price data for the given RS3 item name
        const apiUrl = `https://api.weirdgloop.org/exchange/history/rs/latest?name=${encodeURIComponent(
          itemNameInput
        )}`;
        const response = await fetch(apiUrl);

        if (!response.ok) {
          alert("Error fetching price data from WeirdGloop API.");
          return;
        }

        const data = await response.json();
        // The API returns an object whose single key is the properly cased item name:
        // e.g. { "Abyssal whip": { id: "4151", timestamp: "…", price: 72492, volume: 1326 } }
        const itemKey = Object.keys(data)[0];
        const itemData = data[itemKey];
        const price = itemData.price;
        const id = itemData.id;

        // 2. Construct a thumbnail URL for the RS3 item.
        //    For RS3, item icons can be fetched via secure.runescape.com/m=itemdb_rs/ITEM_ID.png
        const thumbnailUrl = `https://secure.runescape.com/m=itemdb_rs/${id}.png`;

        // 3. Prepare Discord message payload:
        //    - Mention the user via <@USER_ID>
        //    - Include an embed with title, description, and thumbnail
        const content = `<@${userId}> The current price of **${itemKey}** is **${price.toLocaleString()} gp**.`;
        const embed = {
          title: `${itemKey} Price`,
          description: `${price.toLocaleString()} gp`,
          thumbnail: { url: thumbnailUrl },
        };
        const payload = {
          content,
          embeds: [embed],
        };

        // 4. POST to the Discord webhook
        const webhookResponse = await fetch(webhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!webhookResponse.ok) {
          alert("Error sending message to Discord. Check your webhook URL.");
        } else {
          alert("Message sent to Discord successfully!");
        }
      } catch (err) {
        console.error(err);
        alert("An unexpected error occurred. Check console for details.");
      }
    });
  </script>
</body>
</html>
